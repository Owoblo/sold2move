<!DOCTYPE html>
<html>
<head>
    <title>Table Migration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #0A192F; color: #64FFDA; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #112240; border-radius: 8px; }
        .success { color: #4CAF50; }
        .error { color: #F44336; }
        .warning { color: #FF9800; }
        button { background: #64FFDA; color: #0A192F; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #4ECDC4; }
        .table-info { margin: 10px 0; padding: 10px; background: #112240; border-radius: 4px; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Table Migration Test</h1>
    
    <div class="test-section">
        <h2>New Table Structure</h2>
        <div class="table-info">
            <strong>current_listings</strong> - Latest scraped listings
        </div>
        <div class="table-info">
            <strong>previous_listings</strong> - Previous run's listings (for comparison)
        </div>
        <div class="table-info">
            <strong>just_listed</strong> - Newly listed properties
        </div>
        <div class="table-info">
            <strong>sold_listings</strong> - Recently sold properties
        </div>
        <div class="table-info">
            <strong>runs</strong> - Scraping run metadata
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test Data Fetching</h2>
        <button onclick="testHealthCheck()">Test Health Check</button>
        <button onclick="testTableAccess()">Test Table Access</button>
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Migration Summary</h2>
        <ul>
            <li>✅ Updated queries.js to use new table names</li>
            <li>✅ Updated useListingsEnhanced.jsx</li>
            <li>✅ Updated health check to show all table counts</li>
            <li>✅ Updated old useListings.jsx for backward compatibility</li>
            <li>✅ Updated DashboardPage.jsx</li>
        </ul>
    </div>

    <script>
        async function testHealthCheck() {
            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML = '<p>Testing health check...</p>';
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                let html = '<h3>Health Check Results:</h3>';
                html += `<p><strong>Overall Status:</strong> <span class="${data.overall === 'healthy' ? 'success' : 'error'}">${data.overall}</span></p>`;
                
                if (data.checks && data.checks.database) {
                    const db = data.checks.database;
                    html += `<p><strong>Database Status:</strong> <span class="${db.status === 'healthy' ? 'success' : 'error'}">${db.status}</span></p>`;
                    
                    if (db.data) {
                        html += '<h4>Table Counts:</h4>';
                        html += `<p><strong>Runs:</strong> ${db.data.runs?.count || 'N/A'}</p>`;
                        html += `<p><strong>Current Listings:</strong> ${db.data.current_listings?.count || 'N/A'}</p>`;
                        html += `<p><strong>Just Listed:</strong> ${db.data.just_listed?.count || 'N/A'}</p>`;
                        html += `<p><strong>Sold Listings:</strong> ${db.data.sold_listings?.count || 'N/A'}</p>`;
                    }
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function testTableAccess() {
            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML = '<p>Testing table access...</p>';
            
            try {
                // Test if we can access the health check endpoint
                const response = await fetch('/health');
                const data = await response.json();
                
                let html = '<h3>Table Access Test:</h3>';
                
                if (data.checks && data.checks.database && data.checks.database.data) {
                    const tables = ['runs', 'current_listings', 'just_listed', 'sold_listings'];
                    let allAccessible = true;
                    
                    tables.forEach(table => {
                        const count = data.checks.database.data[table]?.count;
                        const hasData = data.checks.database.data[table]?.hasData;
                        const status = count !== undefined ? 'success' : 'error';
                        if (count === undefined) allAccessible = false;
                        
                        html += `<p><strong>${table}:</strong> <span class="${status}">${count !== undefined ? count + ' records' : 'Not accessible'}</span></p>`;
                    });
                    
                    html += `<p><strong>Overall:</strong> <span class="${allAccessible ? 'success' : 'error'}">${allAccessible ? 'All tables accessible' : 'Some tables not accessible'}</span></p>`;
                } else {
                    html += '<p class="error">Could not access database information</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
